<template>
  <section class="home">
    <h2 class="page-title">–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h2>
    <p class="muted">
      –≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      –≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º.
    </p>

    <div class="grid three-columns">
      <article class="card highlight">
        <h3>üìù –§–æ—Ä–º—ã</h3>
        <p>–í—ã–±–æ—Ä –º–µ–∂–¥—É –∑–∞—è–≤–∫–æ–π –Ω–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–æ–π –≤–æ–µ–Ω–Ω–æ–≥–æ —É—á—ë—Ç–∞ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</p>
      </article>
      <article class="card highlight">
        <h3>üë• –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
        <p>–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ–±—â–µ–π —Ç–∞–±–ª–∏—Ü–µ.</p>
      </article>
      <article class="card highlight">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <p>–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –ø–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞–º.</p>
      </article>
    </div>

    <!-- Statistics block -->
    <section class="stats card" style="margin-top:1.25rem;">
      <div class="stats-header">
        <div>
          <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫</h3>
          <p class="muted small">–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞–º</p>
        </div>
      </div>
      <div class="kpi-grid">
        <div class="kpi">
          <div class="kpi-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
          <div class="kpi-value">{{ total }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">–ó–∞ —Ç–µ–∫—É—â–∏–π –≥–æ–¥</div>
          <div class="kpi-value">{{ thisYear }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">–ó–∞ 30 –¥–Ω–µ–π</div>
          <div class="kpi-value">{{ last30 }}</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">–ó–∞ 7 –¥–Ω–µ–π</div>
          <div class="kpi-value">{{ last7 }}</div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <span>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞–º</span>
          <div class="legend">
            <span class="legend-item">
              <span class="legend-swatch swatch-a"></span> –ó–∞—è–≤–∫–∏
            </span>
            <span class="legend-item">–¢–û–ü-6</span>
          </div>
        </div>
        <div class="stat-chart" v-if="Object.keys(perFaculty).length">
          <div class="chart-row" v-for="(count, fac) in topFaculties" :key="fac">
            <div class="fac-name" :title="fac">{{ fac }}</div>
            <div class="bar-wrap" aria-label="bar">
              <div class="bar gradient-a" :style="{ width: (count / maxFacultyCount * 100) + '%' }"></div>
            </div>
            <div class="fac-count">{{ count }}</div>
          </div>
        </div>
        <div v-else class="muted small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</div>
      </div>
    </section>
  </section>
</template>

<script setup>
import { computed } from 'vue';
import { useStudentsStore } from '../stores/students';
import { FACULTIES } from '../data/faculties';

const store = useStudentsStore();
const students = computed(() => store.students);

const total = computed(() => students.value.length);
const thisYear = computed(() => {
  const y = new Date().getFullYear();
  return students.value.filter((s) => s.applicationDate && new Date(s.applicationDate).getFullYear() === y).length;
});

const perFaculty = computed(() => {
  const map = {};
  students.value.forEach((s) => {
    const key = s.facultyName || (FACULTIES.find(f => f.id === s.facultyId)?.name) || '–ù–µ —É–∫–∞–∑–∞–Ω';
    map[key] = (map[key] || 0) + 1;
  });
  return map;
});

const topFaculties = computed(() => {
  return Object.entries(perFaculty.value).sort((a,b) => b[1] - a[1]).slice(0,6).reduce((acc, [k,v]) => {
    acc[k] = v; return acc;
  }, {});
});

const maxFacultyCount = computed(() => Math.max(...Object.values(topFaculties.value || { '': 0 })));

const last7 = computed(() => {
  const now = Date.now();
  const sevenDays = 7 * 24 * 60 * 60 * 1000;
  return students.value.filter((s) => {
    if (!s.applicationDate) return false;
    const t = new Date(s.applicationDate).getTime();
    return now - t <= sevenDays;
  }).length;
});

const last30 = computed(() => {
  const now = Date.now();
  const thirtyDays = 30 * 24 * 60 * 60 * 1000;
  return students.value.filter((s) => {
    if (!s.applicationDate) return false;
    const t = new Date(s.applicationDate).getTime();
    return now - t <= thirtyDays;
  }).length;
});
</script>

<style scoped>
.grid {
  display: grid;
  gap: 1rem;
}

.three-columns {
  grid-template-columns: repeat(3, 1fr);
}

@media (max-width: 968px) {
  .three-columns {
    grid-template-columns: 1fr;
  }
}

.highlight {
  border: 1px solid #e0e7ff;
  background: linear-gradient(180deg, #eef2ff 0%, #fff 70%);
}

.highlight h3 {
  margin-top: 0;
}

.stats { padding: 1rem; }
.stats-header { display:flex; align-items:flex-end; justify-content:space-between; }
.kpi-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 0.75rem;
  margin-top: 0.75rem;
}
.kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:0.75rem }
.kpi-label { color:#64748b; font-size:0.85rem }
.kpi-value { font-weight:800; font-size:1.4rem; margin-top:4px; color:#0f172a }

.chart-card { margin-top: 1rem; border:1px solid #e5e7eb; border-radius:10px; padding:0.75rem; background:#fff }
.chart-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem }
.legend { display:flex; align-items:center; gap:12px }
.legend-item { display:flex; align-items:center; gap:6px; color:#64748b; font-size:0.85rem }
.legend-swatch { width:12px; height:12px; border-radius:3px; display:inline-block }
.swatch-a { background: linear-gradient(90deg,#6366f1,#06b6d4) }

.stat-chart { padding-left: 4px }
.chart-row { display:flex; align-items:center; gap:10px; margin:8px 0 }
.fac-name { width: clamp(160px, 22vw, 280px); font-size:0.95rem; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.bar-wrap { flex:1; background:#f3f4f6; border-radius:999px; height:12px; overflow:hidden }
.bar { height:12px; }
.gradient-a { background: linear-gradient(90deg,#6366f1,#06b6d4); }
.fac-count { width:48px; text-align:right; font-weight:700; color:#0f172a }
</style>


